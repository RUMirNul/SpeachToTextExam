import re
from typing import Tuple
import logging

logger = logging.getLogger(__name__)


class LanguageDetector:
    """Detects language and assesses recognition quality."""
    # УСИЛЕННЫЕ ПОРОГИ - чтобы не убивать реальный русский текст
    MAX_VERY_SHORT_WORDS_RATIO = 0.45  # Максимум 45% слов из 1-2 букв (было 0.5)
    MIN_AVG_WORD_LENGTH = 3.2  # Минимальная средняя длина (было 3.0)
    MIN_VERY_LONG_WORDS_RATIO = 0.15  # Минимум 15% слов >= 5 букв



    @staticmethod
    def detect_language(text: str) -> str:
        """Detect language based on alphabet (Cyrillic/Latin)."""
        cyrillic_count = len(re.findall(r'[а-яёА-ЯЁ]', text))
        latin_count = len(re.findall(r'[a-zA-Z]', text))

        if cyrillic_count == 0 and latin_count == 0:
            return "unknown"

        total = cyrillic_count + latin_count
        cyrillic_ratio = cyrillic_count / total if total > 0 else 0

        if cyrillic_ratio > 0.6:
            return "ru"
        elif cyrillic_ratio < 0.4:
            return "en"
        else:
            return "mixed"

    @staticmethod
    def assess_quality(text: str) -> float:
        """Assess recognition quality (0.0 - 1.0)."""
        if not text.strip():
            return 0.0

        words = text.split()
        word_count = len(words)
        letter_count = len([c for c in text if c.isalpha()])

        # Word count score (0-1)
        word_score = min(word_count / 10, 1.0) * 0.2

        # Letter count score (0-1)
        letter_score = min(letter_count / 50, 1.0) * 0.2

        # Alphabet homogeneity score
        cyrillic_ratio = len(re.findall(r'[а-яёА-ЯЁ]', text)) / max(letter_count, 1)
        latin_ratio = len(re.findall(r'[a-zA-Z]', text)) / max(letter_count, 1)
        alphabet_score = max(cyrillic_ratio, latin_ratio) * 0.2

        # Text length score
        text_len = len(text)
        length_score = 0.2
        if 10 < text_len < 200:
            length_score = 0.2
        elif text_len < 5 or text_len > 300:
            length_score = 0.05

        # Transliteration penalty
        transliteration_penalty = 1.0 if not LanguageDetector.is_transliteration(text) else 0.3

        quality = (word_score + letter_score + alphabet_score + length_score + 0.2) * transliteration_penalty
        return min(quality, 1.0)


    @staticmethod
    def is_transliteration(text: str) -> bool:
        """
        Определяет, является ли текст транслитерацией английской речи.

        УСИЛЕННАЯ версия - меньше ложных срабатываний на реальном русском.

        Args:
            text: текст для проверки

        Returns:
            True если это вероятно транслитерация, False если это реальный русский
        """
        if not text or len(text.strip()) == 0:
            return False

        # Шаг 1: Выделяем только русские слова
        russian_words = re.findall(r'[а-яА-ЯёЁ]+', text.lower())

        if not russian_words:
            return False

        total_words = len(russian_words)

        # Шаг 2: Анализируем статистику слов
        word_lengths = [len(word) for word in russian_words]
        avg_length = sum(word_lengths) / total_words if total_words > 0 else 0

        very_short_words = sum(1 for length in word_lengths if length <= 2)
        very_short_ratio = very_short_words / total_words if total_words > 0 else 0

        very_long_words = sum(1 for length in word_lengths if length >= 5)
        very_long_ratio = very_long_words / total_words if total_words > 0 else 0

        # Шаг 3: Проверяем, есть ли характерные русские слова
        common_russian_count = sum(
            1 for word in russian_words
            if word in LanguageDetector.COMMON_SHORT_RUSSIAN_WORDS
        )
        common_russian_ratio = common_russian_count / total_words if total_words > 0 else 0

        # Шаг 4: Применяем УСИЛЕННЫЕ критерии
        criteria_met = 0
        criteria_details = []

        # Критерий 1: Слишком много коротких слов (> 45%)
        if very_short_ratio > LanguageDetector.MAX_VERY_SHORT_WORDS_RATIO:
            criteria_met += 1
            criteria_details.append(f"очень_короткие: {very_short_ratio * 100:.1f}%")

        # Критерий 2: Слишком низкая средняя длина (< 3.2)
        if avg_length < LanguageDetector.MIN_AVG_WORD_LENGTH:
            criteria_met += 1
            criteria_details.append(f"средняя_длина: {avg_length:.2f}")

        # Критерий 3: Слишком мало длинных слов (< 15%)
        if very_long_ratio < LanguageDetector.MIN_VERY_LONG_WORDS_RATIO:
            criteria_met += 1
            criteria_details.append(f"длинные: {very_long_ratio * 100:.1f}%")

        # Критерий 4: Много характерных русских слов = НЕ транслитерация!
        # Если > 40% слов из типичного русского словаря - это реальный русский
        if common_russian_ratio > 0.4:
            logger.info(
                f"Много характерных русских слов ({common_russian_ratio * 100:.1f}%) - "
                f"это реальный русский текст: '{text[:50]}...'"
            )
            return False

        # УСИЛЕННОЕ правило: требуем 4 критерия вместо 3 или 2
        # Только если ВСЕ 4 критерия выполнены - это транслитерация
        is_transliteration = criteria_met >= 2

        if is_transliteration or criteria_met >= 2:
            logger.info(
                f"Проверка транслитерации: '{text[:50]}...' "
                f"(критерии: {criteria_met}/4, {', '.join(criteria_details)}, "
                f"характ. русск: {common_russian_ratio * 100:.1f}%) "
                f"→ {'ТРАНСЛИТ' if is_transliteration else 'РЕАЛЬНЫЙ'}"
            )

        return is_transliteration


    # Типичные короткие русские слова (не признак транслитерации)
    COMMON_SHORT_RUSSIAN_WORDS = {
        'я', 'а', 'в', 'с', 'к', 'и', 'по', 'на', 'не', 'до', 'да', 'то', 'он', 'ты', 'мы', 'тут', 'шёл', 'шла', 'шли'
        'она', 'они', 'оно', 'это', 'или', 'но', 'мне', 'тебе', 'ему', 'ей', 'им', 'вас', 'нас', 'там', 'чего',
        'того', 'этот', 'такой', 'какой', 'кто', 'что', 'где', 'как', 'когда', 'зачем',
        'ну', 'же', 'вот', 'уж', 'уже', 'даже', 'все', 'весь', 'каждый', 'мой', 'твой',
        'его', 'её', 'наш', 'ваш', 'их', 'хорош', 'плохо', 'хорошо', 'плох', 'дай',
        'возьми', 'пойди', 'иди', 'дайте', 'возьмите', 'идите', 'слушай', 'смотри',
        'помогу', 'помоги', 'помогите', 'спасибо', 'пожалуйста', 'извините', 'извини',
        'тебя', 'тебе', 'в', 'не', 'на', 'с', 'я', 'что', 'он', 'она', 'они',
        'как', 'но', 'до', 'по', 'за', 'к', 'у', 'же', 'мне', 'ты',
        'из', 'бы', 'то', 'так', 'его', 'все', 'еще', 'был', 'там', 'да',
        'вы', 'быть', 'нет', 'это', 'может', 'они', 'над', 'при', 'для', 'без',
        'под', 'над', 'про', 'лишь', 'только', 'даже', 'уже', 'ну', 'во', 'от',
        'кто', 'то', 'ли', 'ни', 'де', 'ми', 'те', 'бе', 'ре', 'ве',
        'ви', 'ди', 'ле', 'ме', 'не', 'ре', 'се', 'те', 'че', 'ше',
        'где', 'когда', 'чего', 'чему', 'чем', 'чей', 'чья', 'чьё', 'чьи', 'какой',
        'такой', 'этот', 'мой', 'твой', 'его', 'её', 'их', 'наш', 'ваш', 'свой',
        'один', 'два', 'три', 'четыре', 'пять', 'шесть', 'семь', 'восемь', 'девять', 'десять',
        'ноль', 'нуль', 'первый', 'второй', 'третий', 'четвёртый', 'пятый', 'большой', 'малый', 'новый',
        'старый', 'добрый', 'злой', 'хороший', 'плохой', 'красивый', 'умный', 'глупый', 'быстро', 'медленно',
        'легкий', 'трудный', 'простой', 'сложный', 'горячий', 'холодный', 'светлый', 'темный', 'чистый', 'грязный',
        'веселый', 'грустный', 'радостный', 'печальный', 'счастливый', 'несчастный', 'честный', 'лживый', 'правдивый', 'важный',
        'интересный', 'скучный', 'ранний', 'поздний', 'дальний', 'ближний', 'левый', 'правый', 'верхний', 'нижний',
        'дом', 'дверь', 'окно', 'стол', 'стул', 'кровать', 'книга', 'ручка', 'ручей', 'река',
        'озеро', 'море', 'лес', 'поле', 'гора', 'город', 'улица', 'школа', 'мама', 'папа',
        'брат', 'сестра', 'сын', 'дочь', 'муж', 'жена', 'друг', 'человек', 'люди', 'мальчик',
        'девочка', 'девушка', 'юноша', 'старик', 'баба', 'бабушка', 'дедушка', 'врач', 'учитель', 'ученик',
        'студент', 'работник', 'начальник', 'сосед', 'знакомый', 'враг', 'глаз', 'нос', 'рот', 'ухо',
        'рука', 'нога', 'голова', 'волос', 'зуб', 'язык', 'сердце', 'печень', 'воздух', 'огонь',
        'вода', 'земля', 'камень', 'песок', 'трава', 'цветок', 'дерево', 'лист', 'ветка', 'корень',
        'хлеб', 'молоко', 'масло', 'мясо', 'рыба', 'яйцо', 'суп', 'каша', 'борщ', 'блюдо',
        'чашка', 'ложка', 'вилка', 'нож', 'пища', 'еда', 'напиток', 'чай', 'кофе', 'вино',
        'пиво', 'спирт', 'газ', 'пар', 'дым', 'запах', 'вкус', 'звук', 'музыка', 'песня',
        'танец', 'картина', 'рисунок', 'фото', 'кино', 'театр', 'цирк', 'игра', 'спорт', 'мяч',
        'лыжа', 'коньки', 'горка', 'елка', 'праздник', 'день', 'ночь', 'утро', 'вечер', 'час',
        'минута', 'секунда', 'год', 'месяц', 'неделя', 'работа', 'дело', 'занятие', 'класс', 'урок',
        'оценка', 'пятёрка', 'четвёрка', 'тройка', 'двойка', 'единица', 'экзамен', 'поэт', 'писатель', 'артист',
        'певец', 'танцор', 'музыкант', 'художник', 'скульптор', 'архитектор', 'инженер', 'механик', 'электрик', 'сантехник',
        'каменщик', 'плотник', 'кузнец', 'портной', 'сапожник', 'парикмахер', 'флорист', 'садовник', 'пастух', 'рыбак',
        'охотник', 'летчик', 'капитан', 'матрос', 'солдат', 'офицер', 'генерал', 'король', 'королева', 'князь',
        'граф', 'герцог', 'барон', 'дворянин', 'боярин', 'хозяин', 'хозяйка', 'слуга', 'служитель', 'раб',
        'крестьянин', 'крестьянка', 'купец', 'ремесленник', 'безработный', 'инвалид', 'сирота', 'вдова', 'вдовец', 'холостяк',
        'молодой', 'молодежь', 'молодость', 'возраст', 'старость', 'детство', 'много', 'немного', 'несколько', 'мало',
        'совсем', 'вовсе', 'очень', 'весьма', 'сильно', 'слабо', 'почти', 'примерно', 'приблизительно', 'около',
        'больше', 'меньше', 'лучше', 'хуже', 'быстрее', 'медленнее', 'выше', 'ниже', 'дальше', 'ближе',
        'раньше', 'позже', 'скорее', 'разнообразнее', 'проще', 'сложнее', 'глубже', 'мельче', 'шире', 'уже',
        'длиннее', 'короче', 'толще', 'тоньше', 'светлее', 'темнее', 'ярче', 'бледнее', 'красивее', 'некрасивее',
        'странно', 'неправда', 'правда', 'конечно', 'наверное', 'может', 'возможно', 'невозможно', 'именно', 'точно',
        'здесь', 'тут', 'туда', 'сюда', 'оттуда', 'отсюда', 'везде', 'всюду', 'нигде', 'никуда',
        'откуда', 'кудаже', 'там', 'далеко', 'близко', 'рядом', 'вместе', 'отдельно', 'другой', 'иной',
        'любой', 'никакой', 'всякий', 'известный', 'неизвестный', 'знаменитый', 'ужас', 'страх', 'страшный', 'ужасный',
        'замечательно', 'отлично', 'весь', 'каждый', 'кое', 'сам', 'себя', 'себе', 'собой', 'собою',
        'начинать', 'заканчивать', 'продолжать', 'останавливаться', 'ждать', 'искать', 'находить', 'терять', 'помнить', 'забывать',
        'думать', 'верить', 'сомневаться', 'решать', 'выбирать', 'соглашаться', 'отказываться', 'спрашивать', 'отвечать', 'рассказывать',
        'обещать', 'выполнять', 'нарушать', 'помогать', 'мешать', 'благодарить', 'извиняться', 'праздновать', 'печалиться', 'радоваться',
        'удивляться', 'страдать', 'любить', 'ненавидеть', 'знать', 'понимать', 'говорить', 'читать', 'писать', 'слушать',
        'смотреть', 'делать', 'работать', 'учиться', 'играть', 'ходить', 'бежать', 'прыгать', 'плавать', 'летать',
        'ехать', 'приезжать', 'уезжать', 'приходить', 'уходить', 'сидеть', 'лежать', 'стоять', 'падать', 'вставать',
        'ложиться', 'дать', 'взять', 'иметь', 'хотеть', 'нужно', 'надо', 'можно', 'нельзя', 'хорошо',
        'плохо', 'красиво', 'да', 'нет', 'вот', 'или', 'союз', 'ле', 'те', 'ве',
    }